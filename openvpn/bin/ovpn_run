#!/bin/bash

#
# Run the OpenVPN server normally
#

if [ "$DEBUG" == "1" ]; then
  set -x
fi

set -e

source "$OPENVPN/ovpn_env.sh"

mkdir -p /dev/net
if [ ! -c /dev/net/tun ]; then
    mknod /dev/net/tun c 10 200
fi

if [ ! -d "$OPENVPN/ccd" ]; then
    mkdir -p /etc/openvpn/ccd
fi

printenv
# Setup NAT forwarding if requested
if [ "$OVPN_DEFROUTE" != "0" ] || [ "$OVPN_NAT" == "1" ] ; then
    #iptables -t nat -C POSTROUTING -s $OVPN_SERVER -d 172.17.0.1/16 -o eth0 -j MASQUERADE || {
    #  iptables -t nat -A POSTROUTING -s $OVPN_SERVER -d 172.17.0.1/16 -o eth0 -j MASQUERADE
    #}
    iptables -t nat -C POSTROUTING -s $OVPN_SERVER -d 10.1.0.0/16 -o eth1 -j MASQUERADE || {
      iptables -t nat -A POSTROUTING -s $OVPN_SERVER -d 10.1.0.0/16 -o eth1 -j MASQUERADE
    }

    iptables -t nat -C POSTROUTING -s $OVPN_SERVER -d 10.2.0.0/16 -o eth2 -j MASQUERADE || {
      iptables -t nat -A POSTROUTING -s $OVPN_SERVER -d 10.2.0.0/16 -o eth2 -j MASQUERADE
    }

    iptables -t nat -C POSTROUTING -s $OVPN_SERVER -d 10.3.0.0/16 -o eth3 -j MASQUERADE || {
      iptables -t nat -A POSTROUTING -s $OVPN_SERVER -d 10.3.0.0/16 -o eth3 -j MASQUERADE
    }

    iptables -t nat -C POSTROUTING -s $OVPN_SERVER -o eth0 -j MASQUERADE || {
      iptables -t nat -A POSTROUTING -s $OVPN_SERVER -o eth0 -j MASQUERADE
    }
fi

conf="$OPENVPN/openvpn.conf"

exec openvpn --config "$conf"
